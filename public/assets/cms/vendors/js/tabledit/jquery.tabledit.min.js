if(typeof jQuery==="undefined"){throw new Error("Tabledit requires jQuery library.")}(function($){"use strict";var dataPrefix="_TableditData";var methods={init:function(options){var $table=this;if($table.prop("tagName")!=="TABLE"){throw new Error("Tabledit only works when applied to a table.")}var notNull=function(value){return value!==undefined||value!==null||value!==""};if(!notNull(options.columns)){console.log("Tabledit Jquery Plugin not initialize. Set required parameters.");return this}if(notNull(options.lang)&&options.lang in $table.Tabledit.langs){options.lang=options.lang.toLowerCase()}else{options.lang=$table.Tabledit.defaults.lang}var settings=$.extend({},$table.Tabledit.defaults,options);$(this).data(dataPrefix,$.extend({},$table.Tabledit.defaults,options||{}));var $lastEditedRow="undefined";var $lastDeletedRow="undefined";var $lastRestoredRow="undefined";if(settings.editButton&&settings.buttons.edit.html){var editButtonHtml=settings.buttons.edit.html}else{var editButtonHtml=$table.Tabledit.langs[settings.lang].btn_edit}if(settings.deleteButton&&settings.buttons.delete.html){var deleteButtonHtml=settings.buttons.delete.html}else{var deleteButtonHtml=$table.Tabledit.langs[settings.lang].btn_delete}if(settings.confirmButton&&settings.buttons.confirm.html){var confirmButtonHtml=settings.buttons.confirm.html}else{var confirmButtonHtml=$table.Tabledit.langs[settings.lang].btn_confirm}if(settings.saveButton&&settings.buttons.save.html){var saveButtonHtml=settings.buttons.save.html}else{var saveButtonHtml=$table.Tabledit.langs[settings.lang].btn_save}if(settings.restoreButton&&settings.buttons.restore.html){var restoreButtonHtml=settings.buttons.restore.html}else{var restoreButtonHtml=$table.Tabledit.langs[settings.lang].btn_restore}if(options.debug)console.log("Tabledit Init -> Element:",$table);if(options.debug)console.log("Tabledit Init -> dataPrefix:",dataPrefix);if(options.debug)console.log("Tabledit Init -> Settings: ",settings);if(options.debug)console.log("Tabledit Init: -----------------------------------");function escapeHTML(string){var entityMap={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"","'":"","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"};return String(string).replace(/[&<>"'`=\/]/g,function(s){return entityMap[s]})}function handleAjaxError(jqXHR,textStatus,errorThrown){var msg="";var statusErrorMap={0:"Not connect. Verify Network.",400:"Server understood the request, but request content was invalid [400].",401:"Unauthorized access [401].",403:"Forbidden resource can not be accessed [403].",404:"Requested page not found. [404]",500:"Internal Server Error [500].",503:"Service unavailable [503]."};if(jqXHR.status){msg=statusErrorMap[jqXHR.status]}else if(textStatus=="parsererror"){msg="Ajax Error!! Parsing JSON Request failed. \n"+"Detail =>"+textStatus+" : "+errorThrown}else if(textStatus==="timeout"){msg="Time out error."}else if(textStatus==="abort"){msg="Ajax request aborted."}else{msg="Uncaught Error.\n"+jqXHR.responseText}return msg}function ajax(action){var jqXHR;var result;var serialize=$table.find(".tabledit-input").serialize();if(!serialize){return false}serialize+="&action="+action;result=settings.onAjax(action,serialize);if(result===false){return false}else{serialize=result}settings.method=settings[action+"method"];function getCookie(name){var cookieValue=null;if(document.cookie&&document.cookie!=""){var cookies=document.cookie.split(";");for(var i=0;i<cookies.length;i++){var cookie=jQuery.trim(cookies[i]);if(cookie.substring(0,name.length+1)==name+"="){cookieValue=decodeURIComponent(cookie.substring(name.length+1));break}}}return cookieValue}function csrfSafeMethod(method){return/^(GET|HEAD|OPTIONS|TRACE)$/.test(method)}$.ajaxSetup({beforeSend:function(xhr,s){if(!csrfSafeMethod(s.type)&&!this.crossDomain){xhr.setRequestHeader("X-CSRFToken",getCookie("csrftoken"))}}});jqXHR=$.ajax({url:settings.url,type:settings.method,data:serialize,dataType:"json"});jqXHR.done(function(data,textStatus,jqXHR){if(textStatus=="success"){if(action===settings.buttons.edit.action){$lastEditedRow.removeClass(settings.dangerClass).addClass(settings.successClass);setTimeout(function(){$table.find("tr."+settings.successClass).removeClass(settings.successClass)},1500)}settings.onSuccess(data,textStatus,jqXHR)}else{settings.onFail(textStatus)}});jqXHR.fail(function(jqXHR,textStatus,errorThrown){if(action===settings.buttons.delete.action){$lastDeletedRow.removeClass(settings.mutedClass).addClass(settings.dangerClass);$lastDeletedRow.find(".tabledit-toolbar button").attr("disabled",false);$lastDeletedRow.find(".tabledit-toolbar .tabledit-restore-button").hide()}else if(action===settings.buttons.edit.action){$lastEditedRow.addClass(settings.dangerClass)}settings.onFail(jqXHR,exception);if(options.debug)console.log(handleAjaxError(jqXHR,textStatus,errorThrown))});jqXHR.always(function(){settings.onAlways()});return jqXHR}var Draw={columns:{identifier:function(){if(settings.hideIdentifier){$table.find("th:nth-child("+parseInt(settings.columns.identifier[0])+1+"), tbody td:nth-child("+parseInt(settings.columns.identifier[0])+1+")").hide()}var $td=$table.find('tbody tr:not(".'+settings.noEditClass+'") td:not(".'+settings.noEditClass+'")').filter(":nth-child("+(parseInt(settings.columns.identifier[0])+1)+")");$td.each(function(){var text=$.trim($(this).text().replace(/^\s+|\s+$/g,""));var text=settings.escapehtml?escapeHTML(text):text;var span='<span class="tabledit-span tabledit-identifier">'+text+"</span>";var input='<input class="tabledit-input tabledit-identifier" type="hidden" name="'+settings.columns.identifier[1]+'" value="'+text+'" disabled>';$(this).html(span+input);$(this).parent("tr").attr(settings.rowIdentifier,$.trim($(this).text()))})},editable:function(){for(var i=0;i<settings.columns.editable.length;i++){var $td=$table.find('tbody tr:not(".'+settings.noEditClass+'") td:not(".'+settings.noEditClass+'")').filter(":nth-child("+(parseInt(settings.columns.editable[i][0])+1)+")");$td.each(function(){var text=$.trim($(this).text().replace(/(^\s+|\s+$)/g,""));var text=settings.escapehtml?escapeHTML(text):text;if(!settings.editButton){$(this).css("cursor","pointer")}var span='<span class="tabledit-span">'+text+"</span>";var input;var supportedTypes=["input","hidden","number","date","select","textarea"];var supportedAttrTextarea=["rows","cols","maxlength","wrap"];var columnType=settings.columns.editable[i][2];if($.inArray(columnType,supportedTypes)==-1){columnType="input"}switch(columnType){case"input":input='<input class="tabledit-input '+settings.inputClass+'" type="text" name="'+settings.columns.editable[i][1]+'" value="'+text+'" style="display: none;" disabled>';break;case"hidden":input='<input class="tabledit-input '+settings.inputClass+'" type="hidden" name="'+settings.columns.editable[i][1]+'" value="'+text+'" style="display: none;" disabled>';break;case"number":input='<input class="tabledit-input '+settings.inputClass+'" type="number" name="'+settings.columns.editable[i][1]+'" value="'+text+'" style="display: none;" disabled>';break;case"date":input='<input class="tabledit-input '+settings.inputClass+'" type="date" name="'+settings.columns.editable[i][1]+'" value="'+text+'" style="display: none;" disabled>';break;case"select":if(typeof settings.columns.editable[i][3]!=="undefined"){input='<select class="tabledit-input '+settings.inputClass+'" name="'+settings.columns.editable[i][1]+'" style="display: none;" disabled>';$.each($.parseJSON(settings.columns.editable[i][3]),function(index,value){value=$.trim(value);if(text===value){input+='<option value="'+index+'" selected>'+value+"</option>"}else{input+='<option value="'+index+'">'+value+"</option>"}});input+="</select>"}break;case"textarea":var counttext;input="<textarea ";if(typeof settings.columns.editable[i][3]!=="undefined"){$.each($.parseJSON(settings.columns.editable[i][3]),function(index,value){input+=$.inArray(index,supportedAttrTextarea)!=-1?index+'="'+value+'" ':"";if(index=="maxlength"&&value.length>0){counttext=$table.Tabledit.langs[settings.lang].txt_allowchar.replace("%s",value)+' | <span class="countno_"></span> '+$table.Tabledit.langs[settings.lang].txt_remain}else{counttext=$table.Tabledit.langs[settings.lang].txt_nolimit}})}else{counttext=$table.Tabledit.langs[settings.lang].txt_nolimit}input+=' class="tabledit-input '+settings.inputClass+'" name="'+settings.columns.editable[i][1]+'" style="display: none;" disabled>'+text+'</textarea><span class="count_" style="display: none;">'+counttext+"</span>";break}$(this).html(span+input);$(this).addClass("tabledit-view-mode")})}},toolbar:function(){if(settings.editButton||settings.deleteButton){var editButton="";var deleteButton="";var saveButton="";var restoreButton="";var confirmButton="";if($table.find("th.tabledit-toolbar-column").length===0){$table.find("tr:first").append('<th class="tabledit-toolbar-column '+settings.toolbarHeaderClass+'">'+$table.Tabledit.langs[settings.lang].txt_action+"</th>")}if(settings.editButton){editButton='<button type="button" class="tabledit-edit-button '+settings.buttons.edit.class+'" style="float: none;">'+editButtonHtml+"</button>"}if(settings.deleteButton){deleteButton='<button type="button" class="tabledit-delete-button '+settings.buttons.delete.class+'" style="float: none; ">'+deleteButtonHtml+"</button>";confirmButton='<button type="button" class="tabledit-confirm-button '+settings.buttons.confirm.class+'" style="display: none; float: none; margin-left: 10px;">'+confirmButtonHtml+"</button>"}if(settings.editButton&&settings.saveButton){saveButton='<button type="button" class="tabledit-save-button '+settings.buttons.save.class+'" style="display: none; float: none; margin-left: 10px;">'+saveButtonHtml+"</button>"}if(settings.deleteButton&&settings.restoreButton){restoreButton='<button type="button" class="tabledit-restore-button '+settings.buttons.restore.class+'" style="display: none; float: none; margin-left: 10px;">'+restoreButtonHtml+"</button>"}var toolbar='<div class="tabledit-toolbar '+settings.toolbarClass+'" style="text-align: left;flex-wrap: nowrap;">\n                                           <div class="'+settings.groupClass+'" style="float: none;">'+editButton+deleteButton+"</div>\n                                           "+saveButton+"\n                                           "+confirmButton+"\n                                           "+restoreButton+"\n                                       </div></div>";$table.find('tbody > tr:not(".'+settings.noEditClass+'")').append('<td class="toolbar" style="white-space: nowrap; width: 1%;">'+toolbar+"</td>");$table.find("tbody > tr."+settings.noEditClass).append('<td class="toolbar" style="white-space: nowrap; width: 1%;"></td>')}}}};var Mode={view:function(td){var $tr=$(td).parent("tr");$(td).parent("tr").find(".tabledit-input.tabledit-identifier").prop("disabled",true);$(td).find(".tabledit-input").blur().hide().prop("disabled",true);$(td).find(".count_").hide();$(td).find(".tabledit-span").show();$(td).addClass("tabledit-view-mode").removeClass("tabledit-edit-mode");if(settings.editButton){$tr.find("button.tabledit-save-button").hide();$tr.find("button.tabledit-edit-button").removeClass("active").blur()}},edit:function(td){Delete.reset(td);var $tr=$(td).parent("tr");$tr.find(".tabledit-input.tabledit-identifier").prop("disabled",false);$(td).find(".tabledit-span").hide();var $input=$(td).find(".tabledit-input");$input.prop("disabled",false).show();$(td).find("textarea").css({resize:"none"});$(td).find(".count_").css({color:"#CCC",display:"block",float:"right"}).show();$(td).find(".countno_").html("...");if(settings.autoFocus){$input.focus()}$(td).addClass("tabledit-edit-mode").removeClass("tabledit-view-mode");if(settings.editButton){$tr.find("button.tabledit-edit-button").addClass("active");$tr.find("button.tabledit-save-button").show()}}};var Edit={reset:function(td){$(td).each(function(){var $input=$(this).find(".tabledit-input");var text=$.trim($(this).find(".tabledit-span").text());if($input.is("select")){$input.find("option").filter(function(){return $.trim($(this).text())===text}).attr("selected",true)}else{$input.val(text)}Mode.view(this)})},submit:function(td){var ajaxResult=ajax(settings.buttons.edit.action);if(ajaxResult===false){return}$(td).each(function(){var $input=$(this).find(".tabledit-input");if($input.is("select")){$(this).find(".tabledit-span").text($.trim($input.find("option:selected").text()))}else{$(this).find(".tabledit-span").text($input.val())}Mode.view(this)});$lastEditedRow=$(td).parent("tr")}};var Delete={reset:function(td){$table.find(".tabledit-confirm-button").hide();$table.find(".tabledit-delete-button").removeClass("active").blur()},submit:function(td){Delete.reset(td);$(td).parent("tr").find("input.tabledit-identifier").attr("disabled",false);var ajaxResult=ajax(settings.buttons.delete.action);$(td).closest("tr").find("input.tabledit-identifier").attr("disabled",true);if(ajaxResult===false){return}$(td).parent("tr").addClass("tabledit-deleted-row");$(td).parent("tr").addClass(settings.mutedClass).find(".tabledit-toolbar button:not(.tabledit-restore-button)").attr("disabled",true);$(td).find(".tabledit-restore-button").show();$lastDeletedRow=$(td).parent("tr")},confirm:function(td){$table.find("td.tabledit-edit-mode").each(function(){Edit.reset(this)});$(td).find(".tabledit-delete-button").addClass("active");$(td).find(".tabledit-confirm-button").show()},restore:function(td){$(td).parent("tr").find("input.tabledit-identifier").attr("disabled",false);var ajaxResult=ajax(settings.buttons.restore.action);$(td).closest("tr").find("input.tabledit-identifier").attr("disabled",true);if(ajaxResult===false){return}$(td).parent("tr").removeClass("tabledit-deleted-row");$(td).parent("tr").removeClass(settings.mutedClass).find(".tabledit-toolbar button").attr("disabled",false);$(td).find(".tabledit-restore-button").hide();$lastRestoredRow=$(td).parent("tr")}};Draw.columns.identifier();Draw.columns.editable();Draw.columns.toolbar();settings.onDraw();if(settings.deleteButton){$table.on("click","button.tabledit-delete-button",function(event){if(event.handled!==true){event.preventDefault();var activated=$(this).hasClass("active");var $td=$(this).closest("td");Delete.reset($td);if(!activated){Delete.confirm($td)}event.handled=true}});$table.on("click","button.tabledit-confirm-button",function(event){if(event.handled!==true){event.preventDefault();var $td=$(this).closest("td");Delete.submit($td);event.handled=true}})}if(settings.restoreButton){$table.on("click","button.tabledit-restore-button",function(event){if(event.handled!==true){event.preventDefault();Delete.restore($(this).closest("td"));event.handled=true}})}if(settings.editButton){$table.on("click","button.tabledit-edit-button",function(event){if(event.handled!==true){event.preventDefault();var $button=$(this);var activated=$button.hasClass("active");Edit.reset($table.find("td.tabledit-edit-mode"));if(!activated){$($button.closest("tr").find("td.tabledit-view-mode").get().reverse()).each(function(){Mode.edit(this)})}event.handled=true}});$table.on("click","button.tabledit-save-button",function(event){if(event.handled!==true){event.preventDefault();Edit.submit($(this).closest("tr").find("td.tabledit-edit-mode"));event.handled=true}})}else{$table.on(settings.eventType,"tr:not(.tabledit-deleted-row) td.tabledit-view-mode",function(event){if(event.handled!==true){event.preventDefault();Edit.reset($table.find("td.tabledit-edit-mode"));Mode.edit(this);event.handled=true}});$table.on("change","select.tabledit-input:visible",function(event){if(event.handled!==true){Edit.submit($(this).parent("td"));event.handled=true}});$(document).on("click",function(event){var $editMode=$table.find(".tabledit-edit-mode");if(!$editMode.is(event.target)&&$editMode.has(event.target).length===0){Edit.reset($table.find(".tabledit-input:visible").parent("td"))}})}$table.on("keypress",function(event){var $input=$table.find(".tabledit-input:visible");var $button=$table.find(".tabledit-confirm-button");if($input.length>0){var $td=$input.parents("td")}else if($button.length>0){var $td=$button.parents("td")}else{return}switch(event.keyCode){case 9:if(!settings.editButton){Edit.submit($td);Mode.edit($td.closest("td").next())}break;case 13:event.preventDefault();Edit.submit($td);break;case 27:Edit.reset($td);Delete.reset($td);break}});$("textarea").on("change keyup keydown",function(){var length=$(this).val().length;var maxLength=$(this).attr("maxlength");if(typeof maxLength!==typeof undefined&&maxLength!==false){if(maxLength.length>0){var length=maxLength-length;$(this).parent().find(".countno_").text(length)}}});return this},destroy:function(options){var $table=this;if(options.debug)console.log("Tabledit Destroy -> Element:",$(this));$table.find(".tabledit-toolbar-column").remove();$table.find(".toolbar").remove();$table.find("td").each(function(){var $input=$(this).find(".tabledit-input");if($input.length!=0){var text=$.trim($(this).find(".tabledit-span").text())}else{var text=$.trim($(this).html())}$(this).html(text)});return},update:function(options){var $table=this;var defaults=$(this).data(dataPrefix);if(!defaults){console.log("Tabledit Update -> Data: EditTable must be initialized before setting options");return}var options=$.extend(true,defaults,options);if(options.debug)console.log("Tabledit Update -> Element:",$(this));if(options.debug)console.log("Tabledit Update -> Settings: ",options);var debugoption=$.parseJSON(JSON.stringify(options,["debug"]));methods.destroy.apply(this,[debugoption]);methods.init.apply(this,[options])}};$.fn.Tabledit=function(method){if(methods[method]){return methods[method].apply(this,Array.prototype.slice.call(arguments,1))}else if(typeof method==="object"||!method){return methods.init.apply(this,arguments)}else{$.error("Method "+method+" does not exist on jQuery.Tabledit")}};$.fn.Tabledit.defaults={url:window.location.href,editmethod:"post",deletemethod:"post",toolbarHeaderClass:"",toolbarClass:"btn-toolbar",groupClass:"btn-group btn-group-sm",inputClass:"form-control input-sm",dangerClass:"danger",successClass:"success",mutedClass:"text-muted",noEditClass:"noedit",eventType:"click",rowIdentifier:"id",hideIdentifier:false,autoFocus:true,lang:"en",debug:false,escapehtml:true,editButton:true,deleteButton:true,saveButton:true,restoreButton:true,buttons:{edit:{class:"btn btn-sm btn-default",html:'<span class="glyphicon glyphicon-pencil"></span>',action:"edit"},delete:{class:"btn btn-sm btn-default",html:'<span class="glyphicon glyphicon-trash"></span>',action:"delete"},save:{class:"btn btn-sm btn-success",html:""},restore:{class:"btn btn-sm btn-warning",html:"",action:"restore"},confirm:{class:"btn btn-sm btn-danger",html:"Confirm"}},onDraw:function(){return},onSuccess:function(){return},onFail:function(){return},onAlways:function(){return},onAjax:function(){return}};$.fn.Tabledit.langs={en:{btn_edit:"Edit",btn_delete:"Delete",btn_confirm:"Confirm",btn_save:"Save",btn_restore:"Restore",txt_action:"Actions",txt_nolimit:"Count of characters without limit",txt_allowchar:"Allowed count of characters %s",txt_remain:"characters remaining"},de:{btn_edit:"Editieren",btn_delete:"L&ouml;schen",btn_confirm:"Best&auml;tigen",btn_save:"Speichern",btn_restore:"Inhalt",txt_action:"Aktion",txt_nolimit:"",txt_allowchar:"",txt_remain:""},fr:{btn_edit:"Editer",btn_delete:"Supprimer",btn_confirm:"Confirmer",btn_save:"Enregistrer",btn_restore:"Restaurer",txt_action:"Actions",txt_nolimit:"Nombre de caractères sans limite",txt_allowchar:"Nombre de caractères autorisés %s",txt_remain:"caractères restants"},cz:{btn_edit:"Editovat",btn_delete:"Odstranit",btn_confirm:"Potvrdit",btn_save:"Uložit",btn_restore:"Obnovit",txt_action:"Akce",txt_nolimit:"Počet znaků bez omezení",txt_allowchar:"Povoleno celkem %s znaků",txt_remain:"znak(ů) zbývá"}}})(jQuery);